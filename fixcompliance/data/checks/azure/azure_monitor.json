{
    "provider": "azure",
    "service": "monitor",
    "checks": [
        {
            "name": "subscription_diagnostic",
            "title": "Ensure that a 'Diagnostic Setting' exists for Subscription Activity Logs",
            "result_kinds": ["azure_subscription"],
            "categories": ["compliance", "security"],
            "risk": "Lack of diagnostic settings for activity logs may lead to insufficient logging and inability to track or analyze security-related activities, breaches, or compliance across Azure resources.",
            "severity": "critical",
            "detect": {
                "fix": "is(azure_subscription) with(empty, -[2]-> is(azure_monitor_diagnostic_settings))"
            },
            "remediation": {
                "manual": "From Azure Portal:\n1. Go to Monitor.\n2. Click on Activity Log.\n3. Click on Export Activity Logs.\n4. Click + Add diagnostic setting.\n5. Enter a Diagnostic setting name.\n6. Select Categories for the diagnostic settings.\n7. Select the appropriate Destination details (Log Analytics, Storage Account, Event Hub, or Partner solution).\n8. Click Save.\nFrom Azure CLI:\nCreate Diagnostic Settings for a subscription:\naz monitor diagnostic-settings subscription create --subscription <subscription id> --name <diagnostic settings name> --logs \"[{category: 'Security', enabled: true}, {category: 'Administrative', enabled: true}]\" --storage-account <storage account ID> --workspace <log analytics workspace ID>"
            },
            "url": "https://docs.microsoft.com/en-us/azure/azure-monitor/platform/activity-log-collect",
            "localizations": {
                "de": {
                    "title": "Stellen Sie sicher, dass eine 'Diagnoseeinstellung' für die Aktivitätsprotokolle des Abonnements existiert",
                    "risk": "Das Fehlen von Diagnoseeinstellungen für Aktivitätsprotokolle kann zu unzureichender Protokollierung und der Unfähigkeit führen, sicherheitsrelevante Aktivitäten, Verstöße oder Compliance über Azure-Ressourcen hinweg zu verfolgen oder zu analysieren.",
                    "remediation": "Vom Azure-Portal:\n1. Gehen Sie zu Monitor.\n2. Klicken Sie auf Aktivitätsprotokoll.\n3. Klicken Sie auf Aktivitätsprotokolle exportieren.\n4. Klicken Sie auf + Diagnoseeinstellung hinzufügen.\n5. Geben Sie einen Namen für die Diagnoseeinstellung ein.\n6. Wählen Sie Kategorien für die Diagnoseeinstellungen.\n7. Wählen Sie die entsprechenden Zielangaben (Log Analytics, Speicherkonto, Event Hub oder Partnerlösung).\n8. Klicken Sie auf Speichern.\nVom Azure CLI:\nErstellen Sie Diagnoseeinstellungen für ein Abonnement:\naz monitor diagnostic-settings subscription create --subscription <Abonnement-ID> --name <Name der Diagnoseeinstellungen> --logs \"[{category: 'Security', enabled: true}, {category: 'Administrative', enabled: true}]\" --storage-account <Speicherkonto-ID> --workspace <Log-Analytics-Workspace-ID>"
                }
            }
        },
        {
            "name": "subscription_diagnostic_captures_categories",
            "title": "Ensure Diagnostic Setting captures appropriate categories for Subscription Activity Logs",
            "result_kinds": ["azure_subscription"],
            "categories": ["compliance", "security"],
            "risk": "Without proper diagnostic settings, capturing crucial management plane activities may be neglected, leading to insufficient oversight and inability to respond to or detect breaches effectively.",
            "severity": "critical",
            "detect": {
                "fix": "is(azure_subscription) with(empty, -[2]-> is(azure_monitor_diagnostic_settings) and logs.administrative.enabled==true and logs.alert.enabled=true and logs.policy.enabled=true and logs.security.enabled=true)"
            },
            "remediation": {
                "manual": "From Azure Portal:\n1. Go to Azure Monitor.\n2. Click Activity log.\n3. Click on Export Activity Logs.\n4. Select the Subscription from the drop down menu.\n5. Click on Add diagnostic setting.\n6. Enter a name for your new Diagnostic Setting.\n7. Ensure the categories Administrative, Alert, Policy, and Security are selected.\n8. Choose the destination details according to your organization's needs.\nFrom Azure CLI:\nConfigure Diagnostic Settings to capture specific categories:\naz monitor diagnostic-settings subscription create --subscription <subscription id> --name <diagnostic settings name> --logs \"[{category: 'Security', enabled: true}, {category: 'Administrative', enabled: true}, {category: 'Alert', enabled: true}, {category: 'Policy', enabled: true}]\" --destination <destination details>\nFrom PowerShell:\nSetup Diagnostic Settings with specified categories enabled:\n$LogCategories = @('Administrative', 'Alert', 'Policy', 'Security') | ForEach-Object { New-AzDiagnosticSettingSubscriptionLogSettingsObject -Category $_ -Enabled $true }\nNew-AzSubscriptionDiagnosticSetting -SubscriptionId <subscription ID> -Name <Diagnostic settings name> -Log $LogCategories"
            },
            "url": "https://docs.microsoft.com/en-us/azure/azure-monitor/platform/diagnostic-settings",
            "localizations": {
                "de": {
                    "title": "Stellen Sie sicher, dass die Diagnoseeinstellung angemessene Kategorien für Abonnement-Aktivitätsprotokolle erfasst",
                    "risk": "Ohne angemessene Diagnoseeinstellungen kann die Erfassung wichtiger Managementebenen-Aktivitäten vernachlässigt werden, was zu unzureichender Überwachung und Unfähigkeit führt, effektiv auf Sicherheitsverletzungen zu reagieren oder diese zu erkennen.",
                    "remediation": "Vom Azure-Portal:\n1. Gehen Sie zu Azure Monitor.\n2. Klicken Sie auf Aktivitätsprotokoll.\n3. Klicken Sie auf Aktivitätsprotokolle exportieren.\n4. Wählen Sie das Abonnement aus dem Dropdown-Menü.\n5. Klicken Sie auf Diagnoseeinstellung hinzufügen.\n6. Geben Sie einen Namen für Ihre neue Diagnoseeinstellung ein.\n7. Stellen Sie sicher, dass die Kategorien Administrative, Alert, Policy und Security ausgewählt sind.\n8. Wählen Sie die Zielangaben gemäß den Bedürfnissen Ihrer Organisation.\nVom Azure CLI:\nKonfigurieren Sie Diagnoseeinstellungen, um spezifische Kategorien zu erfassen:\naz monitor diagnostic-settings subscription create --subscription <Abonnement-ID> --name <Name der Diagnoseeinstellungen> --logs \"[{category: 'Security', enabled: true}, {category: 'Administrative', enabled: true}, {category: 'Alert', enabled: true}, {category: 'Policy', enabled: true}]\" --destination <Zielangaben>\nVom PowerShell:\nRichten Sie Diagnoseeinstellungen mit aktivierten spezifizierten Kategorien ein:\n$LogCategories = @('Administrative', 'Alert', 'Policy', 'Security') | ForEach-Object { New-AzDiagnosticSettingSubscriptionLogSettingsObject -Category $_ -Enabled $true }\nNew-AzSubscriptionDiagnosticSetting -SubscriptionId <Abonnement-ID> -Name <Name der Diagnoseeinstellungen> -Log $LogCategories"
                }
            }
        },
        {
            "name": "logs_storage_encrypted_with_CMK",
            "title": "Ensure the storage account containing the container with activity logs is encrypted with Customer Managed Key (CMK)",
            "result_kinds": ["azure_storage_account"],
            "categories": ["security", "compliance"],
            "risk": "Using default encryption for activity logs stored in storage accounts might not meet certain security compliance requirements. Configuring Customer Managed Keys (CMK) provides greater control over the encryption keys and ensures data confidentiality.",
            "severity": "high",
            "detect": {
                "fix": "is(azure_monitor_subscription_diagnostic_settings) --> is(azure_storage_account) and storage_encryption.key_source!=\"Microsoft.Keyvault\""
            },
            "remediation": {
                "manual": "From Azure Portal:\n1. Navigate to the Storage accounts blade.\n2. Click on the storage account.\n3. Under Security + networking, click Encryption.\n4. Select Customer-managed keys and configure the key.\nFrom Azure CLI:\nUpdate the storage account to use a customer-managed key:\naz storage account update --name <storage account name> --resource-group <resource group> --encryption-key-source Microsoft.Keyvault --encryption-key-vault <Key Vault URI> --encryption-key-name <Key Name> --encryption-key-version <Key Version>\nFrom PowerShell:\nConfigure the storage account to use a customer-managed key:\nSet-AzStorageAccount -ResourceGroupName <resource group name> -Name <storage account name> -KeyVaultEncryption -KeyVaultUri <key vault URI> -KeyName <key name>"
            },
            "url": "https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/activity-log-manage-storage",
            "localizations": {
                "de": {
                    "title": "Stellen Sie sicher, dass das Speicherkonto, das den Container mit Aktivitätsprotokollen enthält, mit einem vom Kunden verwalteten Schlüssel (CMK) verschlüsselt ist",
                    "risk": "Die Verwendung der Standardverschlüsselung für in Speicherkonten gespeicherte Aktivitätsprotokolle entspricht möglicherweise nicht bestimmten Sicherheitsanforderungen. Die Konfiguration von vom Kunden verwalteten Schlüsseln (CMK) bietet eine größere Kontrolle über die Verschlüsselungsschlüssel und gewährleistet die Vertraulichkeit der Daten.",
                    "remediation": "Vom Azure-Portal:\n1. Navigieren Sie zur Speicherkonten-Kachel.\n2. Klicken Sie auf das Speicherkonto.\n3. Unter Sicherheit + Netzwerk, klicken Sie auf Verschlüsselung.\n4. Wählen Sie Vom Kunden verwaltete Schlüssel und konfigurieren Sie den Schlüssel.\nVom Azure CLI:\nAktualisieren Sie das Speicherkonto, um einen vom Kunden verwalteten Schlüssel zu verwenden:\naz storage account update --name <Name des Speicherkontos> --resource-group <Ressourcengruppe> --encryption-key-source Microsoft.Keyvault --encryption-key-vault <Key Vault URI> --encryption-key-name <Schlüsselname> --encryption-key-version <Schlüsselversion>\nVom PowerShell:\nKonfigurieren Sie das Speicherkonto zur Verwendung eines vom Kunden verwalteten Schlüssels:\nSet-AzStorageAccount -ResourceGroupName <Ressourcengruppe> -Name <Name des Speicherkontos> -KeyVaultEncryption -KeyVaultUri <Key Vault URI> -KeyName <Schlüsselname>"
                }
            }
        },
        {
            "name": "key_vault_logging",
            "title": "Ensure that logging for Azure Key Vault is 'Enabled'",
            "result_kinds": ["azure_key_vault"],
            "categories": ["security", "compliance"],
            "risk": "Not enabling logging for interactions with Azure Key Vault can prevent tracking of access and operations, potentially obscuring unauthorized access or operational errors.",
            "severity": "high",
            "detect": {
                "fix": "is(azure_key_vault) with(empty, --> is(azure_monitor_diagnostic_settings) and logs.audit.enabled==true and logs.all_logs.enabled==true)"
            },
            "remediation": {
                "manual": "From Azure Portal:\n1. Navigate to Key Vaults.\n2. For each Key Vault, access Diagnostic settings.\n3. Add or edit settings to enable logging, ensuring categories like 'audit' and 'allLogs' are selected.\nFrom Azure CLI:\nCreate or update diagnostic settings for each Key Vault to enable necessary logging categories.\nFrom PowerShell:\nSet up or adjust diagnostic settings to ensure comprehensive logging for each Key Vault."
            },
            "url": "https://docs.microsoft.com/en-us/azure/key-vault/general/monitoring",
            "localizations": {
                "de": {
                    "title": "Stellen Sie sicher, dass die Protokollierung für Azure Key Vault aktiviert ist",
                    "risk": "Das Nichtaktivieren der Protokollierung für Interaktionen mit Azure Key Vault kann das Nachverfolgen von Zugriffen und Operationen verhindern, wodurch unbefugter Zugriff oder Betriebsfehler möglicherweise nicht erkannt werden.",
                    "remediation": "Vom Azure-Portal:\n1. Navigieren Sie zu Key Vaults.\n2. Überprüfen Sie für jeden Key Vault die diagnostischen Einstellungen, um sicherzustellen, dass die Protokollierung aktiviert und richtig konfiguriert ist.\nVom Azure CLI:\nListen Sie alle Key Vaults auf und überprüfen Sie die diagnostischen Einstellungen für jeden, um zu bestätigen, dass die Protokollierung aktiviert ist.\nVom PowerShell:\nAbrufen und Überprüfen der diagnostischen Einstellungen für jeden Key Vault, um sicherzustellen, dass Protokollierungskategorien wie 'audit' und 'allLogs' aktiv sind."
                }
            }
        },
        {
            "name": "flow_logs_analytics",
            "title": "Ensure that Network Security Group Flow logs are captured and sent to Log Analytics",
            "result_kinds": [],
            "categories": ["security", "compliance"],
            "risk": "Not capturing Network Security Group Flow logs limits visibility into network traffic, potentially obscuring unauthorized network activities or other security threats.",
            "severity": "medium",
            "detect": {
                "manual": "From Azure Portal:\n1. Navigate to Network Watcher.\n2. Select NSG flow logs.\n3. Verify each NSG flow log's settings to ensure they are configured to send data to Log Analytics.\nFrom Azure Policy:\nRefer to policy IDs that ensure all NSG flow logs are enabled and properly configured."
            },
            "remediation": {
                "manual": "From Azure Portal:\n1. Navigate to Network Watcher.\n2. Select NSG flow logs and create a new flow log or update an existing one.\n3. Configure the flow log to send data to Log Analytics, ensuring rich analytics and appropriate retention settings.\n4. Review and create the flow log, confirming all settings are correct before finalizing."
            },
            "url": "https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-portal",
            "localizations": {
                "de": {
                    "title": "Stellen Sie sicher, dass Netzwerksicherheitsgruppen-Datenflussprotokolle erfasst und an Log Analytics gesendet werden",
                    "risk": "Das Nichterfassen von Netzwerksicherheitsgruppen-Datenflussprotokollen schränkt die Sichtbarkeit des Netzwerkverkehrs ein und kann unbefugte Netzwerkaktivitäten oder andere Sicherheitsbedrohungen verschleiern.",
                    "remediation": "Vom Azure-Portal:\n1. Navigieren Sie zum Network Watcher.\n2. Wählen Sie NSG-Datenflussprotokolle und erstellen Sie ein neues Datenflussprotokoll oder aktualisieren Sie ein vorhandenes.\n3. Konfigurieren Sie das Datenflussprotokoll so, dass Daten an Log Analytics gesendet werden, wobei reichhaltige Analysen und angemessene Aufbewahrungseinstellungen sichergestellt sind.\n4. Überprüfen und erstellen Sie das Datenflussprotokoll und bestätigen Sie, dass alle Einstellungen korrekt sind."
                }
            }
        },
        {
            "name": "appservice_http_logs",
            "title": "Ensure that logging for Azure AppService 'HTTP logs' is enabled",
            "result_kinds": [],
            "categories": ["security", "compliance"],
            "risk": "Not capturing HTTP logs for Azure App Services may result in missing critical data needed for security analysis and incident response.",
            "severity": "medium",
            "detect": {
                "manual": "From Azure Portal:\n1. Navigate to App Services.\n2. For each App Service, go to Diagnostic Settings.\n3. Verify that 'HTTP logs' is configured to log to a destination suitable for your organization’s log consumption needs."
            },
            "remediation": {
                "manual": "From Azure Portal:\n1. Navigate to App Services.\n2. For each App Service, go to Diagnostic Settings.\n3. Click Add Diagnostic Setting.\n4. Check the checkbox next to 'HTTP logs'.\n5. Configure the log destination according to your organization's logging strategy (e.g., stream to an event hub for SIEM integration)."
            },
            "url": "https://docs.microsoft.com/en-us/azure/app-service/troubleshoot-diagnostic-logs",
            "localizations": {
                "de": {
                    "title": "Stellen Sie sicher, dass das Logging für Azure AppService 'HTTP-Logs' aktiviert ist",
                    "risk": "Das Nichterfassen von HTTP-Logs für Azure App Services kann dazu führen, dass kritische Daten, die für die Sicherheitsanalyse und die Reaktion auf Vorfälle benötigt werden, fehlen.",
                    "remediation": "Vom Azure-Portal:\n1. Navigieren Sie zu App Services.\n2. Für jeden App Service gehen Sie zu den Diagnoseeinstellungen.\n3. Klicken Sie auf Diagnoseeinstellung hinzufügen.\n4. Aktivieren Sie das Kontrollkästchen neben 'HTTP-Logs'.\n5. Konfigurieren Sie das Ziel des Logs gemäß der Protokollstrategie Ihrer Organisation (z.B. Stream zu einem Ereignishub für SIEM-Integration)."
                }
            }
        }

    ]
}
